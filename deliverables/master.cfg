#-*- python -*-
# vim: set syntax=python:
from buildbot.plugins import secrets
from buildbot.plugins import *
from datetime import timedelta

c = BuildmasterConfig = {}

# Token GitHubowy przechowywany w pliku - nie wrzucam do repo
c['secretsProviders'] = [
    secrets.SecretInAFile(dirname="/var/lib/buildbot/secrets", strip=True),
]

# Konfiguracja workera - w produkcji zmiencie hasło na bezpieczne
c['workers'] = [
    worker.Worker("example-worker", "pass"),
]
c['protocols'] = {'pb': {'port': 9989}}

# Repozytorium główne i credentials
MAIN_REPO_URL = "https://github.com/donfirst/phoenix-rtos-project.git"
MAIN_REPO_CRED = util.GitCredentialOptions(
    credentials=[
        util.Interpolate(
            f"url={MAIN_REPO_URL}\n"
            "username=git\n"
            "password=%(secret:github_token)s\n"
        )
    ]
)

# Monitoruje zmiany w repo - pollujemy co 5 minut ( do zmiany wedlug potrzeb)
c['change_source'] = []

c['change_source'].append(changes.GitPoller(
    repourl=MAIN_REPO_URL,
    branches=['master'],
    pollInterval=300,
    project='phoenix-rtos-project',
    pollAtLaunch=True,
    git_credentials=MAIN_REPO_CRED,
))

# Submoduły które monitoruje  dla HEAD builds
SUBMODULES = [
    ("phoenix-rtos-kernel", "donfirst/phoenix-rtos-kernel"),
    ("phoenix-rtos-devices", "donfirst/phoenix-rtos-devices"),
    ("phoenix-rtos-build", "donfirst/phoenix-rtos-build"),
    ("libphoenix", "donfirst/libphoenix"),
    ("phoenix-rtos-filesystems", "donfirst/phoenix-rtos-filesystems"),
    ("phoenix-rtos-corelibs", "donfirst/phoenix-rtos-corelibs"),
    ("phoenix-rtos-doc", "donfirst/phoenix-rtos-doc"),
    ("phoenix-rtos-hostutils", "donfirst/phoenix-rtos-hostutils"),
]
for submodule_name, repo_path in SUBMODULES:
    submodule_url = f"https://github.com/{repo_path}.git"
    submodule_cred = util.GitCredentialOptions(
        credentials=[
            util.Interpolate(
                f"url={submodule_url}\n"
                "username=git\n"
                "password=%(secret:github_token)s\n"
            )
        ]
    )
    c['change_source'].append(changes.GitPoller(
        repourl=submodule_url,
        branches=['master'],
        pollInterval=300,
        project=submodule_name,
        pollAtLaunch=True,
        git_credentials=submodule_cred,
    ))

# Schedulery sterują kiedy się buduje
c['schedulers'] = [
    # Stable - triggerujemy na commit do main repo
    schedulers.SingleBranchScheduler(
        name="stable",
        change_filter=util.ChangeFilter(
            project="phoenix-rtos-project", branch="master"
        ),
        treeStableTimer=60,
        builderNames=[
            "stable-ia32-generic-qemu",
            "stable-armv7a7-imx6ull-evk",
            "stable-riscv64-generic-spike",
        ],
    ),
    # Head - triggeruje na commit do submodułów, testuje z najnowszymi wersjami
    schedulers.SingleBranchScheduler(
        name="head",
        change_filter=util.ChangeFilter(
            project_re="^phoenix-rtos-.*|^libphoenix$", branch="master"
        ),
        treeStableTimer=60,
        builderNames=[
            "head-ia32-generic-qemu",
            "head-armv7a7-imx6ull-evk",
            "head-riscv64-generic-spike",
        ],
    ),
    # Force - jak potrzebuje zbudować coś ręcznie z web UI
    schedulers.ForceScheduler(
        name="force",
        builderNames=[
            "stable-ia32-generic-qemu",
            "stable-armv7a7-imx6ull-evk",
            "stable-riscv64-generic-spike",
            "head-ia32-generic-qemu",
            "head-armv7a7-imx6ull-evk",
            "head-riscv64-generic-spike",
        ],
    ),
]

def create_phoenix_build_factory(target, is_head_build=False):
    factory = util.BuildFactory()

    if is_head_build:
        # HEAD build - checkout główny repo i potem aktualizuje wszystkie submoduły do HEAD
        # Sprawdzam czy nowy commit w submodule zbuduje się z innymi najnowszymi wersjami
        factory.addStep(steps.Git(
            repourl=MAIN_REPO_URL,
            branch="master",
            mode="full",
            submodules=True,
            git_credentials=MAIN_REPO_CRED,
            description="Checking out with latest submodules",
        ))
        factory.addStep(steps.ShellCommand(
            command=[
                "bash", "-c",
                util.Interpolate(
                    "git config --global "
                    "url.\"https://%(secret:github_token)s@github.com/\".insteadOf "
                    "\"https://github.com/\" && "
                    "git submodule sync && git submodule update --remote --recursive"
                )
            ],
            description="Updating submodules to HEAD",
            descriptionDone="Updated submodules",
            haltOnFailure=True,
            usePTY=True,
        ))
    else:
        # Stable build - checkout submodułów w określonych wersjach te z gitmodules)
        factory.addStep(steps.Git(
            repourl=MAIN_REPO_URL,
            branch="master",
            mode="full",
            submodules=True,
            git_credentials=MAIN_REPO_CRED,
            description="Checking out stable",
        ))

    # Buduje- uzywam  docker jeśli istnieje, inaczej native build
    factory.addStep(steps.ShellCommand(
        command=[
            "bash", "-c",
            util.Interpolate(
                "if [ -f docker-build.sh ]; then "
                "./docker-build.sh all; "
                "else "
                f"TARGET={target} ./phoenix-rtos-build/build.sh all; "
                "fi"
            )
        ],
        env={"TARGET": target},
        timeout=3600,
        description=util.Interpolate(f"Building {target}"),
        descriptionDone=util.Interpolate(f"Built {target}"),
        haltOnFailure=True,
        usePTY=True,
    ))

    # Sprawdzam czy coś się zbudowało - list wynikowych obrazów
    factory.addStep(steps.ShellCommand(
        command=["ls", "-lh", "_boot/"],
        description="Listing built images",
        descriptionDone="Images verified",
        flunkOnFailure=False,
    ))

    return factory

# Konfiguruje buildery dla każdej architektury
c['builders'] = []
TARGETS = [
    "ia32-generic-qemu",
    "armv7a7-imx6ull-evk",
    "riscv64-generic-spike",
]

# Stable buildery
for target in TARGETS:
    c['builders'].append(
        util.BuilderConfig(
            name=f"stable-{target}",
            workernames=["example-worker"],
            factory=create_phoenix_build_factory(target, is_head_build=False),
            tags=["stable", target.split("-")[0]],
        )
    )

# Head buildery
for target in TARGETS:
    c['builders'].append(
        util.BuilderConfig(
            name=f"head-{target}",
            workernames=["example-worker"],
            factory=create_phoenix_build_factory(target, is_head_build=True),
            tags=["head", target.split("-")[0]],
        )
    )

# Raportuje status buildów do GitHub - tylko stable builds mają status viditelny
c['services'] = []
c['services'].append(reporters.GitHubStatusPush(
    token=util.Secret('github_token'),
    context=util.Interpolate("buildbot/%(prop:buildername)s"),
    verbose=True,
))

# Interfejs web na porcie 8010 - w produkcji zmiencie hasło admin/admin!
c['www'] = dict(
    port=8010,
    plugins=dict(
        waterfall_view={},
        console_view={},
        grid_view={},
    ),
    auth=util.UserPasswordAuth([(("admin", "admin"))]),  # Produkcja: zmiencie haslo hasło!
    authz=util.Authz(
        allowRules=[
            util.AnyEndpointMatcher(role="admins", defaultDeny=False)
        ],
        roleMatchers=[
            util.RolesFromUsername(roles=["admins"], usernames=["admin"])
        ]
    ),
)

c['title'] = "Phoenix-RTOS CI"
c['titleURL'] = "https://github.com/donfirst/phoenix-rtos-project"
c['buildbotURL'] = "http://localhost:8010/"
c['db'] = {'db_url': "sqlite:///state.sqlite"}
c['logCompressionLimit'] = 16777216

# Czyszczenie starych logów co tydzień (logHorizon = 4 tygodnie)
c['configurators'] = [util.JanitorConfigurator(
    logHorizon=timedelta(weeks=4), hour=12,
)]

print("=" * 80)
print("Phoenix-RTOS Buildbot CI initialized")
print("=" * 80)
print(f"Monitoring: 1 main repo + {len(SUBMODULES)} submodules")
print(f"Build targets: {', '.join(TARGETS)}")
print(f"Total builders: {len(c['builders'])} (stable + head)")
print("=" * 80)

